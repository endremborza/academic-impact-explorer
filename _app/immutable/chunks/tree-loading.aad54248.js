import{D as z,S as F}from"./constants.30a985e8.js";const J={include:[],exclude:[],limit_n:z,show_top:!0,size_base:"volume"};function Q(e,t,n,s,o,r,d){const a=I(t,n,s,(p,v)=>{const E=N(v,r);return K(t,$[E],v,e,r,d,o).specMetric}),m=[{totalNodes:1,totalWeight:t.weight}],_={name:"",weight:t.weight,isSelected:!0,children:{},childrenSumWeight:0,totalOffsetOnLevel:{weight:0,rank:0},totalOffsetAmongSiblings:{weight:0,rank:0},scaleEnds:{min:0,max:1,mid:.5},specMetric:{rawMetric:0,normalizedMetric:0}},g=p=>L(p.path.slice(0,-1),_),C=p=>p.path.slice(0,-1).join("-");for(const[p,v]of a.slice(1).entries()){const E=n[p];let O=0,c=0;const i={},S=[],f=(h,l)=>{const y=g(h),b=g(l);if((y==null?void 0:y.totalOffsetOnLevel.rank)==(b==null?void 0:b.totalOffsetOnLevel.rank)){const j=h.derivedWeight-l.derivedWeight;return j!=0?j:w(h.path)>w(l.path)?-1:1}return((y==null?void 0:y.totalOffsetOnLevel.rank)||0)-((b==null?void 0:b.totalOffsetOnLevel.rank)||0)};for(const h of v){const l=C(h);i[l]=(i[l]||0)+1,M(h,S,f)}for(const h of S){const l=g(h),y=i[C(h)];if((l==null?void 0:l.children)!=null){const b=((l==null?void 0:l.scaleEnds.max)-(l==null?void 0:l.scaleEnds.min))/(y||1),j=w(h.path),D=Object.keys(l.children).length,W=l.scaleEnds.min+(D||0)*b,G=W+b,x=E.size_base=="specialization"?{rawMetric:h.node.weight,normalizedMetric:0}:{rawMetric:0,normalizedMetric:0};l.children[j]={name:R(h.path,o,r),weight:h.derivedWeight,isSelected:P(h.path,s),children:{},childrenSumWeight:0,totalOffsetOnLevel:{weight:O,rank:c},totalOffsetAmongSiblings:{weight:l.childrenSumWeight,rank:D},scaleEnds:{min:W,max:G,mid:(G+W)/2},specMetric:x},l.childrenSumWeight+=h.derivedWeight,O+=h.derivedWeight,c+=1}}m.push({totalWeight:O,totalNodes:c})}return{tree:_,meta:m}}function I(e,t,n,s){var r,d;const o=[[{path:[],node:e,derivedWeight:0}]];e:for(let u=0;u<t.length;u++){const a=t[u];let m=a.limit_n;const _=o[u],g=[],C=new Set,p=a.size_base=="volume"?c=>c.weight:s,v=a.show_top?(c,i)=>c.derivedWeight-i.derivedWeight:(c,i)=>i.derivedWeight-c.derivedWeight,E=(c,i)=>{if(a.exclude.includes(i))return;const S=[...c.path,i],f=c.node.children[i];C.add(S.join("-")),g.push({node:f,path:S,derivedWeight:p(f,S)}),m--},O=_.filter(c=>P(c.path,n));if(O.length==0)break;o.push(g);for(const c of O)for(const i of Object.keys(((r=L(c.path,n))==null?void 0:r.children)||{}))if(E(c,i),m==0)continue e;for(const c of a.include)for(const i of O)if(Object.hasOwn(((d=i.node)==null?void 0:d.children)||{},c)&&!C.has([...i.path,c].join("-"))&&(E(i,c),m==0))continue e;for(const[c,i]of O.entries()){const S=Math.round(m/(O.length-c));if(S==0)continue;const f=[];for(const[h,l]of Object.entries(i.node.children||{})){if(a.exclude.includes(h))continue;const y=[...i.path,h];if(C.has(y.join("-")))continue;const b={node:l,path:y,derivedWeight:p(l,y)};f.length<S?M(b,f,v):v(f[0],b)<0&&(f.shift(),M(b,f,v))}f.map(h=>g.push(h)),m-=f.length}}return o}function X(e,t,n){const s=[],o=Math.max((((e==null?void 0:e.meta)||[]).length||0)-1,1);let r=0;const d=n===void 0?t/o:t/o/2;for(let u=0;u<o;u++){const a=n==u?t/2+d:d;s.push({totalSize:a,topOffset:r}),r+=a}return s}function M(e,t,n){let s=0,o=t.length-1,r,d;for(;s<=o;){if(r=Math.floor((s+o)/2),d=n(t[r],e),d==0)return t.splice(r,0,e);d<0?s=r+1:o=r-1}t.splice(s,0,e)}function L(e,t){let n=t;for(const s of e)if(n=((n==null?void 0:n.children)||{})[s],n===void 0)return n;return n}function P(e,t){return L(e,t)!=null}function A(e){const t=[];for(const[n,s]of Object.entries(e.children||{}))return[n,...A(s)];return t}function R(e,t,n){var r;if(t===void 0)return"Loading...";const s=w(e),o=N(e,n);return(r=t[o][s])==null?void 0:r.name}function N(e,t){return t.bifurcations[e.length-1].attribute_kind}const Y=e=>e.join("x"),Z=e=>e.split("x");function w(e){return e[e.length-1]}const B=["Institution-Country-Global","Concept-Continent-Institution","Institution-Country-Country","Concept-Country-Institution"],$={Institution:{basis:"Global",hierarchy:"Global"},Concept:{basis:"Global",hierarchy:"Global"},Country:{basis:"Global",hierarchy:"Global"},SubConcept:{basis:"Global",hierarchy:"Concept"},Continent:{basis:"Global",hierarchy:"Global"}},U={Continent:"continent__id",Country:"country__id"};function K(e,t,n,s,o,r,d){var c;const u=N(n,o),a=L(n,e),m=n[n.length-1];let _=e.weight,g=r[T(u,t.basis,t.hierarchy)];if(t.basis!="Global"&&(g=g[d[o.root_entity_type][s].meta[U[t.basis]||t.basis]]),t.hierarchy!="Global"){for(let i=n.length-2;i>=0;i--)if(t.hierarchy==o.bifurcations[i].attribute_kind){const S=n[i],f=L(n.slice(0,i+1),e);g=g[S],_=f==null?void 0:f.weight;break}}else for(let i=n.length-2;i>0;i--)if(o.root_entity_type==o.bifurcations[i].attribute_kind){_=(c=L(n.slice(0,i+1),e))==null?void 0:c.weight;break}const C=g[m]||0,p=((a==null?void 0:a.weight)||0)/_,v=L(n.slice(0,-1),e),O=1/Object.keys((v==null?void 0:v.children)||{}).length;return{nodeRate:p,nodeDivisor:_,baselineRate:C,specMetric:(p+O)/(C+O)}}function T(e,t,n){return`${e}-${t}-${n}`}function H(e){const[t,n,s]=e.split("-");return{target:t,basis:n,hierarchy:s}}function k(e,t){return fetch(`${F}/${e}.json.gz`).then(n=>n.json().then(s=>t(s)))}function q(){const e=k("attribute-statics",s=>Object.fromEntries(Object.entries(s).map(([o,r])=>[o,Object.fromEntries(Object.entries(r).map(([d,u])=>{let a;try{a=JSON.parse(u.meta)}catch{a={}}return[d,{...u,meta:a}]}))]))),t=k("qc-specs",s=>s),n=k("available-rca-baselines",s=>{const o=[];for(const[r,d,u]of s.baselines){const a=T(r,d,u);B.includes(a)||o.push(k(`rca-baselines/${a}`,m=>[a,m]))}return Promise.all(o).then(Object.fromEntries)});return Promise.all([e,t,n])}export{J as D,X as a,A as b,N as c,Q as d,K as e,$ as f,L as g,k as h,R as i,q as m,Z as p,H as s,Y as t};
